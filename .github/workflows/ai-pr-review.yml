name: AI PR Review (Gemini)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1. Fetch PR data
      # ------------------------------------------------------------
      - name: Fetch PR data
        uses: actions/github-script@v7
        id: pr
        with:
          script: |
            const pr = context.payload.pull_request

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              }
            )

            const result = {
              title: pr.title,
              additions: pr.additions,
              deletions: pr.deletions,
              changed_files: pr.changed_files,
              files: files.map(f => ({
                filename: f.filename,
                status: f.status,
                patch: f.patch ? f.patch.slice(0, 3000) : ""
              }))
            }

            console.log("PR DATA:", JSON.stringify(result, null, 2))
            return result

      # ------------------------------------------------------------
      # 2. Generate AI review with Gemini
      # ------------------------------------------------------------
      - name: Generate AI review with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_DATA: ${{ steps.pr.outputs.result }}
        run: |
          echo "==== RAW PR_DATA ===="
          echo "$PR_DATA"
          echo "====================="

          # Encode PR data safely so JSON never breaks
          ENCODED_PR_DATA=$(echo "$PR_DATA" | base64 -w 0)

          cat << EOF > request.json
          {
            "contents": [
              {
                "role": "user",
                "parts": [
                  {
                    "text": "You are a senior software engineer performing a professional pull request review.\n\nRULES:\n- Follow the output format EXACTLY\n- Be detailed, critical, and constructive\n- Do NOT hallucinate\n- If something cannot be determined, say so explicitly\n\nIMPORTANT:\nThe PR data below is Base64 encoded. Decode it before reviewing.\n\nOUTPUT FORMAT:\n<!-- ai-pr-review -->\n\n## ü§ñ AI PR Review\n\n### üìå Overview\n- **Purpose:**\n- **Scope:**\n- **Risk level:**\n\n---\n\n### üìä Change Summary\n\n---\n\n### üß† Detailed Code Review\n\n---\n\n### üîê Security Review\n\n---\n\n### üß™ Testing Assessment\n\n---\n\n### ‚ùó Issues & Suggestions\n\n---\n\n### ‚úÖ Final Recommendation\n\n\nBASE64_PR_DATA:\n$ENCODED_PR_DATA"
                  }
                ]
              }
            ],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 2048
            }
          }
          EOF

          echo "==== REQUEST.JSON ===="
          cat request.json
          echo "======================"

          curl -s \
            -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json \
            > response.json

          echo "==== GEMINI RESPONSE (RAW) ===="
          cat response.json
          echo "==============================="

          # üî• CRITICAL FIX:
          # -r = raw output (unescapes \n)
          # sed = remove leading/trailing quotes if present
          jq -r '.candidates[0].content.parts[0].text' response.json \
            | sed '1s/^"//; $s/"$//' > review.md || {
              echo "‚ùå Gemini did not return candidates"
              cat response.json
              exit 1
            }

          echo "==== GENERATED REVIEW (MARKDOWN) ===="
          cat review.md
          echo "===================================="

      # ------------------------------------------------------------
      # 3. Post or update PR comment
      # ------------------------------------------------------------
      - name: Post or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const body = fs.readFileSync('review.md', 'utf8')
            const marker = '<!-- ai-pr-review -->'

            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              }
            )

            const existing = comments.find(c => c.body.includes(marker))

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              })
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body
              })
            }
