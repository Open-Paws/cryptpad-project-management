name: AI PR Review (Gemini)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1. Fetch PR data
      # ------------------------------------------------------------
      - name: Fetch PR data
        uses: actions/github-script@v7
        id: pr
        with:
          script: |
            const pr = context.payload.pull_request

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              }
            )

            const result = {
              title: pr.title,
              additions: pr.additions,
              deletions: pr.deletions,
              changed_files: pr.changed_files,
              files: files.map(f => ({
                filename: f.filename,
                status: f.status,
                patch: f.patch ? f.patch.slice(0, 3000) : ""
              }))
            }

            console.log("PR DATA:", JSON.stringify(result, null, 2))
            return result

      # ------------------------------------------------------------
      # 2. Generate AI review with Gemini (CONCISE MODE)
      # ------------------------------------------------------------
      - name: Generate AI review with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_DATA: ${{ steps.pr.outputs.result }}
        run: |
          echo "==== RAW PR_DATA ===="
          echo "$PR_DATA"
          echo "====================="

          ENCODED_PR_DATA=$(echo "$PR_DATA" | base64 -w 0)

          cat << EOF > request.json
          {
            "contents": [
              {
                "role": "user",
                "parts": [
                  {
                    "text": "You are a senior software engineer performing a pull request review.\n\nCRITICAL RULES (MUST FOLLOW):\n- Use ONLY bullet points (no paragraphs).\n- Maximum 3 bullet points per section.\n- Each bullet must be ONE sentence.\n- Be concise and reviewer-friendly.\n- Do NOT explain obvious changes.\n- Do NOT repeat the diff.\n- Do NOT write essays.\n\nOUTPUT FORMAT (FOLLOW EXACTLY):\n\n<!-- ai-pr-review -->\n\n## ü§ñ AI PR Review (Concise)\n\n### üìå Overview\n- Purpose:\n- Scope:\n- Risk level:\n\n---\n\n### üìä Change Summary (Table)\n| Area | Files | Summary |\n|-----|------|--------|\n| UI | | |\n| Logic | | |\n| CI/CD | | |\n\n---\n\n### üß† Key Review Points\n- Architecture:\n- Correctness:\n- Edge cases:\n\n---\n\n### üîê Security & Quality\n- Security:\n- Accessibility:\n- Maintainability:\n\n---\n\n### üß™ Testing Gaps\n- Missing tests:\n- Risk areas:\n\n---\n\n### ‚úÖ Recommendation\n- Verdict:\n- Required fixes:\n\nIMPORTANT:\n- The PR data below is Base64 encoded.\n- Decode it before reviewing.\n- If information is insufficient, say \"Not enough context\".\n\nBASE64_PR_DATA:\n$ENCODED_PR_DATA"
                  }
                ]
              }
            ],
            "generationConfig": {
              "temperature": 0.2,
            }
          }
          EOF

          curl -s \
            -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json \
            > response.json

          jq -r '.candidates[0].content.parts[0].text' response.json \
            | sed '1s/^"//; $s/"$//' > review.md || {
              echo "‚ùå Gemini did not return candidates"
              cat response.json
              exit 1
            }

          echo "==== GENERATED REVIEW (MARKDOWN) ===="
          cat review.md
          echo "===================================="

      # ------------------------------------------------------------
      # 3. Post or update PR comment
      # ------------------------------------------------------------
      - name: Post or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const body = fs.readFileSync('review.md', 'utf8')
            const marker = '<!-- ai-pr-review -->'

            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              }
            )

            const existing = comments.find(c => c.body.includes(marker))

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              })
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body
              })
            }
